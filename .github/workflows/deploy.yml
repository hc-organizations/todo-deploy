name: Deploy to VM

on:
  repository_dispatch:
    types: [frontend-update, backend-update]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    concurrency:
      group: production-deploy
      cancel-in-progress: false

    env:
      DEPLOY_PATH: /home/${{ secrets.VM_USER }}/deploy

    steps:
      # 1) 배포 레포지토리 체크아웃
      - name: Checkout deploy repo
        uses: actions/checkout@v3
        with:
          ref: main

      # 2) 원격에 deploy 디렉터리 생성
      - name: Ensure deploy dir exists on server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            mkdir -p $DEPLOY_PATH

      # 3) docker-compose.yml 파일을 정확한 경로로 복사
      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          source: docker-compose.yml
          target: $DEPLOY_PATH/docker-compose.yml

      # 4) .env 파일 생성
      - name: Generate .env on server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cat > $DEPLOY_PATH/.env <<EOF
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            API_URL=${{ secrets.API_URL }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            ASYNC_DATABASE_URL=${{ secrets.ASYNC_DATABASE_URL }}
            SYNC_DATABASE_URL=${{ secrets.SYNC_DATABASE_URL }}
            DB_ECHO_LOG=${{ secrets.DB_ECHO_LOG }}
            EOF

      # 5) dispatch payload에서 서비스 이름을 환경변수로 설정
      - name: Set SERVICE from dispatch payload
        run: echo "SERVICE=${{ github.event.client_payload.service }}" >> $GITHUB_ENV

      # 6) 변경된 서비스만 pull & up
      - name: Deploy updated service via Docker Compose
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd $DEPLOY_PATH
            docker compose pull $SERVICE
            docker compose up -d $SERVICE
